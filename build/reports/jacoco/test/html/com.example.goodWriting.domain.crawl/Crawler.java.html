<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ko"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Crawler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">goodWriting</a> &gt; <a href="index.source.html" class="el_package">com.example.goodWriting.domain.crawl</a> &gt; <span class="el_source">Crawler.java</span></div><h1>Crawler.java</h1><pre class="source lang-java linenums">package com.example.goodWriting.domain.crawl;

import java.io.IOException;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.regex.Pattern;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.springframework.stereotype.Component;

@Component
<span class="fc" id="L16">public class Crawler {</span>

	//한글이 추가 되지 않는 부분을 추가
	private static final String URL_REGEX = &quot;^(http|https)://[a-z0-9ㄱ-ㅎ가-힣]+([\\-\\.]{1}[a-z0-9ㄱ-ㅎ가-힣]+)*\\.[a-z]{2,5}(:[0-9]{1,5})?(/[a-zA-Z0-9ㄱ-ㅎ가-힣\\-\\._\\?,'/\\\\+&amp;amp;%$#=~]*)?$&quot;;

	public CrawledDataDTO getData(String inputUrl) {
<span class="fc" id="L22">		String url = inputUrl;</span>

<span class="fc" id="L24">		Document doc = null;</span>
		try {
<span class="fc" id="L26">			doc = Jsoup.connect(url).timeout(5000).get();</span>
<span class="nc" id="L27">		} catch (IOException e) {</span>
<span class="nc" id="L28">			throw new RuntimeException(&quot;Connection timed out after 5 seconds&quot;, e);</span>
<span class="fc" id="L29">		}</span>

		// 제목
<span class="fc" id="L32">		String title = doc.select(&quot;meta[property=og:title]&quot;).attr(&quot;content&quot;);</span>
		// 내용
<span class="fc" id="L34">		String description = doc.select(&quot;meta[property=og:description]&quot;).attr(&quot;content&quot;);</span>
		// 이미지
<span class="fc" id="L36">		String image = doc.select(&quot;meta[property=twitter:image]&quot;).attr(&quot;content&quot;);</span>

		//제목이 없는 경우
<span class="pc bpc" id="L39" title="1 of 2 branches missed.">		if (title.isEmpty()) {</span>
<span class="nc" id="L40">			title = &quot;제목을 입력해주세요&quot;;</span>
		}

		//내용이 없는 경우
<span class="pc bpc" id="L44" title="1 of 2 branches missed.">		if (description.isEmpty()) {</span>
<span class="nc" id="L45">			description = &quot;간단한 설명을 입력해주세요&quot;;</span>
		}

		//이미지가 없는 경우 첫번째 이미지
<span class="pc bpc" id="L49" title="1 of 2 branches missed.">		if (image.isEmpty()) {</span>
<span class="fc" id="L50">			Elements images = doc.select(&quot;img&quot;);</span>
<span class="fc bfc" id="L51" title="All 2 branches covered.">			for (Element firstImage : images) {</span>
<span class="fc" id="L52">				String imageUrl = firstImage.attr(&quot;abs:src&quot;);</span>
<span class="pc bpc" id="L53" title="1 of 4 branches missed.">				if (imageUrl != null &amp;&amp; !imageUrl.isEmpty()) {</span>
<span class="fc" id="L54">					image = imageUrl;</span>
				}
<span class="fc" id="L56">			}</span>
		}

		//기본이미지
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">		if (image.isEmpty()) {</span>
<span class="nc" id="L61">			image = &quot;https://www.edology.com/build/images/logo-og.jpg&quot;;</span>
		}

<span class="fc" id="L64">		return new CrawledDataDTO(title, description, image);</span>

	}

	public String addHttpsUrl(String url) {
<span class="fc" id="L69">		url = url.trim();</span>

<span class="fc bfc" id="L71" title="All 2 branches covered.">		if (url.startsWith(&quot;https://&quot;)) {</span>
<span class="fc" id="L72">			return url;</span>
		}

<span class="fc" id="L75">		url = &quot;https://&quot; + url;</span>

<span class="fc" id="L77">		return url;</span>
	}

	public boolean isValidUrl(String url) throws IOException {

<span class="fc" id="L82">		url = addHttpsUrl(url);</span>

		//이메일 유효성 검사
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">		if (isMatchRegex(url) == false) {</span>
<span class="nc" id="L86">			return false;</span>
		}

<span class="fc bfc" id="L89" title="All 2 branches covered.">		if (isHttpResponseOk(url) == false) {</span>
<span class="fc" id="L90">			return false;</span>
		}

<span class="fc" id="L93">		return true;</span>

	}

	public boolean isMatchRegex(String url) {
<span class="fc" id="L98">		return Pattern.matches(URL_REGEX, url);</span>
	}

	public boolean isHttpResponseOk(String url) throws IOException {
<span class="fc" id="L102">		URL connectedUrl = new URL(url);</span>
<span class="fc" id="L103">		HttpURLConnection connection = (HttpURLConnection)connectedUrl.openConnection();</span>
<span class="fc" id="L104">		connection.setRequestMethod(&quot;GET&quot;);</span>
<span class="fc" id="L105">		connection.connect();</span>
<span class="fc" id="L106">		int statusCode = connection.getResponseCode();</span>

<span class="fc bfc" id="L108" title="All 2 branches covered.">		if (statusCode == 404) {</span>
<span class="fc" id="L109">			System.out.println(statusCode);</span>
<span class="fc" id="L110">			return false;</span>
		}

<span class="fc" id="L113">		connection.disconnect();</span>

<span class="fc" id="L115">		return true;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>